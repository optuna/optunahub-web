{{- $scratch := newScratch }}
{{- $scratch.Add "index" slice }}
{{- range .RegularPagesRecursive }}
  {{- if strings.Contains .Permalink "static/" }}{{ continue }}{{ end }}
  {{- $scratch.Add "tags" slice }}
  {{- range (.GetTerms "tags") }}
    {{- $scratch.Add "tags" (dict "title" .LinkTitle "permalink" (printf "/?%s" ((querify "q" .LinkTitle) | safeURL))) }}
  {{- end }}
  {{- $imageUrl := false }}
  {{- with findRESubmatch `(?i)<img[^>]+src=["']([^"']+)["']` .Content 1 }}
    {{- $imageUrl = index (index . 0) 1 }}
  {{- end }}
  {{- if $imageUrl }}
    {{- $imageUrl = (.Resources.GetMatch $imageUrl).RelPermalink }}
  {{- end }}
  {{- $scratch.Add "index" (dict "title" .Title "tags" ($scratch.Get "tags") "description" .Description "image" $imageUrl "permalink" .RelPermalink "last_update" .Params.last_update  "last_update_epoch" .Params.last_update_epoch) }}
  {{- $scratch.Delete "tags" }}
{{- end }}
{{- $scratch.Get "index" | jsonify }}
{{- $scratch.Delete "index" }}
